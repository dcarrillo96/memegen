<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Overlay App</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js" crossorigin></script>
  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin></script>
  <!-- Add FFMPEG.wasm for video processing -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js" crossorigin></script>
  <script src="https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js" crossorigin></script>
  <style>
    /* Reset and base styles */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      color: #333;
      background: #f5f5f5;
    }
    
    /* App container */
    #video-overlay-app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    @media (min-width: 1024px) {
      .app-container {
        flex-direction: row;
        align-items: flex-start;
      }
    }
    
    /* Controls panel */
    .controls-panel {
      flex: 1;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 580px;
    }
    
    .panel-header {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 12px;
      margin-bottom: 16px;
    }
    
    .panel-title {
      font-size: 20px;
      font-weight: 700;
    }
    
    .input-group {
      margin-bottom: 16px;
    }
    
    .input-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }
    
    .text-input, 
    .file-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .range-input {
      width: 100%;
    }
    
    .range-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }
    
    .color-input {
      width: 40px;
      height: 40px;
      padding: 0;
      border: 0;
    }
    
    .color-display {
      font-size: 12px;
      margin-left: 8px;
    }
    
    .color-container {
      display: flex;
      align-items: center;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .download-btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: auto;
    }
    
    .download-btn:hover {
      background: #1d4ed8;
    }
    
    .download-btn:disabled {
      background: #9cb3f0;
      cursor: not-allowed;
    }
    
    /* Download options dropdown */
    .download-options {
      position: relative;
      margin-top: 10px;
    }
    
    .download-dropdown {
      width: 100%;
      padding: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
    }
    
    /* Progress bar */
    .progress-container {
      width: 100%;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      margin-top: 10px;
      overflow: hidden;
      display: none;
    }
    
    .progress-bar {
      height: 100%;
      background-color: #2563eb;
      width: 0%;
      transition: width 0.3s;
    }
    
    .status-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 5px;
      text-align: center;
    }
    
    /* Preview area */
    .preview-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .preview-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    /* Frame container */
    .video-frame {
      position: relative;
      width: 320px;
      height: 570px; /* 16:9 vertical aspect ratio based on 320px width */
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    /* Video wrapper */
    .video-wrapper {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
    }
    
    /* Video element */
    .video-element {
      width: 100%; /* Fill the frame width */
      height: auto; /* Maintain aspect ratio */
      display: block;
    }
    
    /* Placeholder content */
    .placeholder-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      width: 100%;
      color: #9ca3af;
      text-align: center;
      padding: 20px;
    }
    
    .placeholder-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
    }
    
    /* Help text */
    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 16px;
      text-align: center;
      max-width: 300px;
    }
    
    /* Push content to bottom */
    .spacer {
      flex-grow: 1;
    }
    
    /* Console log area for debugging */
    .console-log {
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      background: #f1f5f9;
      border-radius: 4px;
      margin-top: 10px;
      max-height: 100px;
      overflow-y: auto;
      display: none;
    }
    
    /* Modal */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 100%;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .btn {
      padding: 8px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }
  </style>
</head>
<body>
  <div id="video-overlay-app"></div>

  <script type="text/babel">
    // Main app component
    const VideoOverlayApp = () => {
      const [videoFile, setVideoFile] = React.useState(null);
      const [videoFileName, setVideoFileName] = React.useState(""); // Store original filename
      const [text, setText] = React.useState('Sample Overlay Text');
      const [textColor, setTextColor] = React.useState('#FFFFFF');
      const [textSize, setTextSize] = React.useState(17);
      const [logoSize, setLogoSize] = React.useState(200); // Default to 200px
      const [showControls, setShowControls] = React.useState(true);
      const [videoHeight, setVideoHeight] = React.useState(0);
      const [videoWidth, setVideoWidth] = React.useState(0);
      const [isProcessing, setIsProcessing] = React.useState(false);
      const [progress, setProgress] = React.useState(0);
      const [statusMessage, setStatusMessage] = React.useState("");
      const [downloadType, setDownloadType] = React.useState("screenshot");
      const [showModal, setShowModal] = React.useState(false);
      const [modalMessage, setModalMessage] = React.useState("");
      const [ffmpegLoaded, setFfmpegLoaded] = React.useState(false);
      const [ffmpeg, setFfmpeg] = React.useState(null);
      
      const videoRef = React.useRef(null);
      const frameRef = React.useRef(null);
      const consoleLogRef = React.useRef(null);
      const progressBarRef = React.useRef(null);
      const progressContainerRef = React.useRef(null);
      
      // Your logo file
      const logo = "./sportsbets glow tran.png";
      
      // Initialize FFmpeg when component mounts
      React.useEffect(() => {
        const loadFFmpeg = async () => {
          try {
            if (typeof FFmpeg !== 'undefined') {
              const ffmpegInstance = FFmpeg.createFFmpeg({ 
                log: true,
                progress: ({ ratio }) => {
                  setProgress(Math.round(ratio * 100));
                }
              });
              await ffmpegInstance.load();
              setFfmpeg(ffmpegInstance);
              setFfmpegLoaded(true);
              console.log("FFmpeg loaded successfully");
            } else {
              console.error("FFmpeg is not defined. Video export will not be available.");
              setModalMessage("Video export feature is not available. The FFmpeg library failed to load. You can still use the screenshot feature.");
              setShowModal(true);
            }
          } catch (error) {
            console.error("Error loading FFmpeg:", error);
            setModalMessage("Video export feature is not available due to an error. You can still use the screenshot feature.");
            setShowModal(true);
          }
        };
        
        loadFFmpeg();
      }, []);
      
      // Update video dimensions when metadata loads
      React.useEffect(() => {
        if (videoRef.current && videoFile) {
          const updateDimensions = () => {
            setVideoWidth(videoRef.current.videoWidth);
            setVideoHeight(videoRef.current.videoHeight);
            console.log("Video dimensions updated:", videoRef.current.videoWidth, videoRef.current.videoHeight);
          };
          
          videoRef.current.addEventListener('loadedmetadata', updateDimensions);
          videoRef.current.addEventListener('loadeddata', updateDimensions);
          
          // Also try to get dimensions if already loaded
          if (videoRef.current.readyState >= 2) {
            updateDimensions();
          }
          
          return () => {
            if (videoRef.current) {
              videoRef.current.removeEventListener('loadedmetadata', updateDimensions);
              videoRef.current.removeEventListener('loadeddata', updateDimensions);
            }
          };
        }
      }, [videoFile]);
      
      const logMessage = (message) => {
        console.log(message);
        if (consoleLogRef.current) {
          consoleLogRef.current.style.display = "block";
          consoleLogRef.current.innerHTML += `${message}<br>`;
          consoleLogRef.current.scrollTop = consoleLogRef.current.scrollHeight;
        }
      };
      
      const handleVideoUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          setVideoFileName(file.name);
          setVideoFile(URL.createObjectURL(file));
          
          // Reset progress
          setProgress(0);
          setStatusMessage("");
          if (progressContainerRef.current) {
            progressContainerRef.current.style.display = "none";
          }
        }
      };
      
      const captureScreenshot = () => {
        if (!window.html2canvas) {
          alert("Screenshot library not loaded. Please refresh and try again.");
          return;
        }
        
        // Hide video controls before capture
        setShowControls(false);
        
        // Wait for state update to propagate
        setTimeout(() => {
          html2canvas(frameRef.current).then(canvas => {
            const link = document.createElement('a');
            link.download = 'video-overlay.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            // Restore controls
            setShowControls(true);
          }).catch(err => {
            console.error("Screenshot failed:", err);
            setShowControls(true);
            alert("Screenshot failed. Please try again.");
          });
        }, 100);
      };
      
      const processVideo = async () => {
        if (!videoFile || !ffmpegLoaded || !ffmpeg) {
          setModalMessage("Video processing is not available. Please make sure you've uploaded a video and that the FFmpeg library is loaded.");
          setShowModal(true);
          return;
        }
        
        try {
          setIsProcessing(true);
          setStatusMessage("Starting video processing...");
          
          if (progressContainerRef.current) {
            progressContainerRef.current.style.display = "block";
          }
          
          // First create the overlays
          setStatusMessage("Creating text overlay...");
          setProgress(5);
          
          // Capture the frame with overlays but without video
          const originalVideoSrc = videoRef.current.src;
          const originalControls = showControls;
          
          // Hide video controls
          setShowControls(false);
          
          // Wait for render
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Capture the frame for overlays
          const canvas = await html2canvas(frameRef.current);
          
          // Restore video
          setShowControls(originalControls);
          
          setStatusMessage("Processing video...");
          setProgress(20);
          
          // Fetch the video file as an ArrayBuffer
          const videoResponse = await fetch(videoFile);
          const videoData = await videoResponse.arrayBuffer();
          
          // Convert the canvas to a data URL, then to a Blob, then to an ArrayBuffer
          const overlayDataUrl = canvas.toDataURL('image/png');
          const overlayBlob = await (await fetch(overlayDataUrl)).blob();
          const overlayArrayBuffer = await overlayBlob.arrayBuffer();
          
          // Write both files to FFmpeg's virtual file system
          ffmpeg.FS('writeFile', 'input.mp4', new Uint8Array(videoData));
          ffmpeg.FS('writeFile', 'overlay.png', new Uint8Array(overlayArrayBuffer));
          
          setStatusMessage("Applying overlays to video...");
          setProgress(40);
          
          // Run FFmpeg command to overlay the image on the video
          await ffmpeg.run(
            '-i', 'input.mp4',
            '-i', 'overlay.png',
            '-filter_complex', '[0:v][1:v]overlay=0:0',
            '-c:a', 'copy',
            'output.mp4'
          );
          
          setStatusMessage("Finalizing video...");
          setProgress(90);
          
          // Read the result
          const data = ffmpeg.FS('readFile', 'output.mp4');
          
          // Create a downloadable URL
          const blob = new Blob([data.buffer], { type: 'video/mp4' });
          const url = URL.createObjectURL(blob);
          
          // Create a link to download
          const link = document.createElement('a');
          link.href = url;
          link.download = videoFileName ? `overlay_${videoFileName}` : 'video-with-overlay.mp4';
          
          setStatusMessage("Download ready!");
          setProgress(100);
          
          // Trigger download
          link.click();
          
          // Clean up
          setTimeout(() => {
            URL.revokeObjectURL(url);
            if (progressContainerRef.current) {
              progressContainerRef.current.style.display = "none";
            }
            setIsProcessing(false);
            setStatusMessage("");
          }, 2000);
          
        } catch (error) {
          console.error("Error processing video:", error);
          setIsProcessing(false);
          setStatusMessage("Error processing video");
          setModalMessage(`An error occurred while processing the video: ${error.message}. Try using the screenshot option instead.`);
          setShowModal(true);
        }
      };
      
      const handleDownload = () => {
        if (downloadType === "screenshot") {
          captureScreenshot();
        } else if (downloadType === "video") {
          processVideo();
        }
      };
      
      // Custom component for the video with overlays
      const VideoWithOverlays = () => {
        const [videoDimensions, setVideoDimensions] = React.useState({width: 0, height: 0});
        const [isVideoReady, setIsVideoReady] = React.useState(false);

        // Additional event handlers to ensure video is ready
        const handleVideoLoad = () => {
          console.log("Video loaded!");
          setIsVideoReady(true);
          setVideoDimensions({
            width: videoRef.current?.videoWidth || 0,
            height: videoRef.current?.videoHeight || 0
          });
        };

        return (
          <div style={{ 
            position: 'relative',
            width: '100%', 
            height: '100%',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center'
          }}>
            {/* The video element */}
            <video 
              ref={videoRef}
              src={videoFile}
              className="video-element"
              controls={showControls} 
              muted 
              loop
              autoPlay
              style={{
                width: '100%',
                objectFit: 'contain' 
              }}
              onLoadedMetadata={handleVideoLoad}
              onLoadedData={handleVideoLoad}
            />
            
            {/* Text overlay - exactly 10px above the video */}
            {text && isVideoReady && (
              <div 
                style={{
                  position: 'absolute',
                  width: '100%',
                  textAlign: 'center',
                  fontWeight: 'bold',
                  color: textColor,
                  fontSize: `${textSize}px`,
                  textShadow: '1px 1px 3px rgba(0,0,0,0.8)',
                  top: '0',
                  paddingTop: '10px',
                  zIndex: 10,
                  wordBreak: 'break-word',
                  padding: '0 5px'
                }}
              >
                {text}
              </div>
            )}
            
            {/* Logo overlay - exactly 10px below the video */}
            {isVideoReady && (
              <div 
                style={{
                  position: 'absolute',
                  width: '100%',
                  display: 'flex',
                  justifyContent: 'center',
                  bottom: '0',
                  paddingBottom: '10px',
                  zIndex: 10
                }}
              >
                <img 
                  src={logo}
                  style={{ width: `${logoSize}px` }}
                  alt="Logo" 
                  onError={(e) => {
                    console.error('Logo failed to load');
                    e.target.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22250%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22250%22%20height%3D%22100%22%20fill%3D%22%23eee%22%2F%3E%3Ctext%20x%3D%22125%22%20y%3D%2250%22%20font-size%3D%2216%22%20text-anchor%3D%22middle%22%20alignment-baseline%3D%22middle%22%20fill%3D%22%23aaa%22%3ELogo%3C%2Ftext%3E%3C%2Fsvg%3E';
                  }}
                />
              </div>
            )}
          </div>
        );
      };
      
      // Modal component
      const Modal = ({ show, message, onClose }) => {
        if (!show) return null;
        
        return (
          <div className="modal-backdrop">
            <div className="modal-content">
              <div className="modal-title">Information</div>
              <div className="modal-body">{message}</div>
              <div className="modal-footer">
                <button className="btn btn-primary" onClick={onClose}>
                  OK
                </button>
              </div>
            </div>
          </div>
        );
      };
      
      return (
        <div className="app-container">
          {/* Controls Panel */}
          <div className="controls-panel">
            <div className="panel-header">
              <h2 className="panel-title">Video Overlay Editor</h2>
            </div>
            
            <div className="input-group">
              <label className="input-label">Upload Video</label>
              <input 
                type="file" 
                accept="video/*" 
                onChange={handleVideoUpload}
                className="file-input" 
                disabled={isProcessing}
              />
            </div>
            
            <div className="input-group">
              <label className="input-label">Text Overlay</label>
              <input
                type="text"
                placeholder="Enter text overlay..."
                value={text}
                onChange={(e) => setText(e.target.value)}
                className="text-input"
                disabled={isProcessing}
              />
            </div>
            
            <div className="grid-2">
              <div className="input-group">
                <label className="input-label">Text Color</label>
                <div className="color-container">
                  <input
                    type="color"
                    value={textColor}
                    onChange={(e) => setTextColor(e.target.value)}
                    className="color-input"
                    disabled={isProcessing}
                  />
                  <span className="color-display">{textColor}</span>
                </div>
              </div>
              
              <div className="input-group">
                <label className="input-label">Text Size: {textSize}px</label>
                <input
                  type="range"
                  min="12"
                  max="48"
                  value={textSize}
                  onChange={(e) => setTextSize(Number(e.target.value))}
                  className="range-input"
                  disabled={isProcessing}
                />
              </div>
            </div>
            
            <div className="input-group">
              <label className="input-label">Logo Size: {logoSize}px</label>
              <input
                type="range"
                min="100"
                max="250"
                step="5"
                value={logoSize}
                onChange={(e) => setLogoSize(Number(e.target.value))}
                className="range-input"
                disabled={isProcessing}
              />
            </div>
            
            <div className="download-options">
              <label className="input-label">Download Format</label>
              <select 
                className="download-dropdown" 
                value={downloadType} 
                onChange={(e) => setDownloadType(e.target.value)}
                disabled={isProcessing}
              >
                <option value="screenshot">PNG Screenshot</option>
                <option value="video" disabled={!ffmpegLoaded}>MP4 Video with Overlays {!ffmpegLoaded && "(Unavailable)"}</option>
              </select>
              
              <div 
                className="progress-container" 
                ref={progressContainerRef}
              >
                <div 
                  className="progress-bar" 
                  ref={progressBarRef}
                  style={{ width: `${progress}%` }} 
                ></div>
              </div>
              
              {statusMessage && (
                <div className="status-text">{statusMessage}</div>
              )}
            </div>
            
            <div className="spacer"></div>
            
            <div className="console-log" ref={consoleLogRef}></div>
            
            <button 
              onClick={handleDownload} 
              className="download-btn"
              disabled={isProcessing || !videoFile}
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              {isProcessing ? "Processing..." : `Download ${downloadType === "screenshot" ? "Screenshot" : "Video"}`}
            </button>
          </div>
          
          {/* Preview */}
          <div className="preview-container">
            <h3 className="preview-title">Preview</h3>
            
            {/* Main frame with 16:9 vertical aspect ratio */}
            <div 
              ref={frameRef}
              className="video-frame"
              style={{ 
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                padding: videoFile ? '0' : '20px'
              }}
            >
              {videoFile ? (
                <div className="video-wrapper">
                  <VideoWithOverlays />
                </div>
              ) : (
                <div className="placeholder-container">
                  <svg className="placeholder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round">
                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                  </svg>
                  <p>Upload a video to see preview</p>
                  
                  {/* Show sample text position */}
                  {text && (
                    <div style={{ color: textColor, fontSize: `${textSize}px`, margin: '20px 0', textAlign: 'center', fontWeight: 'bold', textShadow: '1px 1px 3px rgba(0,0,0,0.8)' }}>
                      {text}
                    </div>
                  )}
                  
                  {/* Show sample logo position */}
                  <img 
                    src={logo}
                    style={{ width: `${logoSize}px`, marginTop: '20px' }}
                    alt="Logo" 
                    onError={(e) => {
                      console.error('Logo failed to load');
                      e.target.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22250%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22250%22%20height%3D%22100%22%20fill%3D%22%23eee%22%2F%3E%3Ctext%20x%3D%22125%22%20y%3D%2250%22%20font-size%3D%2216%22%20text-anchor%3D%22middle%22%20alignment-baseline%3D%22middle%22%20fill%3D%22%23aaa%22%3ELogo%3C%2Ftext%3E%3C%2Fsvg%3E';
                    }}
                  />
                </div>
              )}
            </div>
            
            <p className="help-text">
              Video shown in 16:9 vertical frame. Text appears exactly 10px above the video and logo 10px below.
            </p>
          </div>
          
          {/* Modal for notifications */}
          <Modal 
            show={showModal} 
            message={modalMessage} 
            onClose={() => setShowModal(false)} 
          />
        </div>
      );
    };

    // Render the app
    ReactDOM.render(
      <VideoOverlayApp />,
      document.getElementById('video-overlay-app')
    );
  </script>
</body>
</html>
